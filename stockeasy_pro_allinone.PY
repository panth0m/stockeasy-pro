"""
StockEasy PRO Ultimate - All-in-One ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
- íŒ¨í‚¤ì§€ ì„¤ì¹˜
- PyUpbit/RSI/Whale í…ŒìŠ¤íŠ¸
- Streamlit ëŒ€ì‹œë³´ë“œ í¬í•¨
"""



print("\nëª¨ë“  íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ âœ…\n")

# -------------------------------
# 2ï¸âƒ£ PyUpbit í…ŒìŠ¤íŠ¸
# -------------------------------
import pyupbit
import pandas as pd
import numpy as np
import requests

print("KRW ì½”ì¸ ë¦¬ìŠ¤íŠ¸ (ìƒìœ„ 5ê°œ):")
tickers = pyupbit.get_tickers(fiat="KRW")
print(tickers[:5])

# BTC 4ì‹œê°„ë´‰ ë°ì´í„° í™•ì¸
df_btc = pyupbit.get_ohlcv("KRW-BTC", interval="minute240", count=30)
print("\nBTC 4ì‹œê°„ë´‰ ìµœê·¼ 5ê°œ ë°ì´í„°:")
print(df_btc.tail())

# RSI ê³„ì‚° í•¨ìˆ˜
def get_rsi(df, period=14):
    delta = df['close'].diff()
    gain = delta.clip(lower=0)
    loss = -delta.clip(upper=0)
    avg_gain = gain.rolling(period).mean()
    avg_loss = loss.rolling(period).mean()
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

df_btc['rsi'] = get_rsi(df_btc)
print("\nBTC RSI ìµœê·¼ 5ê°œ:")
print(df_btc[['close','rsi']].tail())

# -------------------------------
# 3ï¸âƒ£ Solscan Whale API í…ŒìŠ¤íŠ¸
# -------------------------------
url = "https://api.solscan.io/leaderboard/whale-tracking"
try:
    resp = requests.get(url, timeout=5).json()
    data = resp.get("data", [])
except:
    data = []

print("\nìµœê·¼ 3ê°œ Whale ê±°ë˜ í™•ì¸:")
print(data[:3])

# ORCA Whale í•„í„°
orca_whales = [tx for tx in data if tx.get("Action")=="ORCA" and float(tx.get("Amount",0))>=100000]
print("\nORCA Whale ê±°ë˜ í™•ì¸ (ìµœëŒ€ 3ê°œ):")
print(orca_whales[:3])

# -------------------------------
# 4ï¸âƒ£ Streamlit ëŒ€ì‹œë³´ë“œ ì½”ë“œ
# -------------------------------
import streamlit as st

st.set_page_config(page_title="StockEasy PRO Ultimate", layout="wide")
st.title("ğŸ”¥ StockEasy PRO Ultimate - All-in-One Trading Dashboard")

#########################################
# RSI ê³„ì‚° í•¨ìˆ˜ (ëŒ€ì‹œë³´ë“œìš©)
#########################################
def get_rsi_dashboard(df, period=14):
    delta = df['close'].diff()
    gain = delta.clip(lower=0)
    loss = -delta.clip(upper=0)
    avg_gain = gain.rolling(period).mean()
    avg_loss = loss.rolling(period).mean()
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

#########################################
# 1ï¸âƒ£ BTC ìƒíƒœ
#########################################
@st.cache_data(ttl=300)
def get_btc_status():
    df = pyupbit.get_ohlcv("KRW-BTC", interval="day", count=30)
    df['ma20'] = df['close'].rolling(20).mean()
    btc_return = (df['close'][-1] / df['close'][-2] - 1) * 100
    trend = "ìƒìŠ¹" if df['close'].iloc[-1] > df['ma20'].iloc[-1] else "í•˜ë½"
    return round(btc_return,2), trend

btc_return, btc_trend = get_btc_status()
col1, col2 = st.columns(2)
col1.metric("BTC 24h ìˆ˜ìµë¥ ", f"{btc_return}%")
col2.metric("BTC ì¶”ì„¸", btc_trend)

#########################################
# 2ï¸âƒ£ 4ì‹œê°„ë´‰ ì£¼ë„ì½”ì¸
#########################################
@st.cache_data(ttl=300)
def get_leaders():
    tickers = pyupbit.get_tickers(fiat="KRW")
    result = []
    btc_df = pyupbit.get_ohlcv("KRW-BTC", interval="minute240", count=2)
    btc_return_4h = (btc_df['close'][-1] / btc_df['close'][-2] - 1) * 100
    for ticker in tickers:
        try:
            df = pyupbit.get_ohlcv(ticker, interval="minute240", count=30)
            if df is None: continue
            df['rsi'] = get_rsi_dashboard(df)
            coin_return = (df['close'][-1] / df['close'][-2] - 1) * 100
            strength = coin_return - btc_return_4h
            volume_spike = df['volume'][-1] > df['volume'][:-1].mean() * 2
            if volume_spike and strength > 0:
                result.append((ticker, round(coin_return,2), round(strength,2), round(df['rsi'].iloc[-1],1)))
        except: continue
    df_result = pd.DataFrame(result, columns=["ì½”ì¸","4Hìˆ˜ìµë¥ ","BTCëŒ€ë¹„ê°•ë„","RSI"])
    return df_result.sort_values(by="BTCëŒ€ë¹„ê°•ë„", ascending=False).head(10)

st.subheader("ğŸš€ 4ì‹œê°„ë´‰ ì£¼ë„ì½”ì¸")
st.dataframe(get_leaders(), use_container_width=True)

#########################################
# 8ï¸âƒ£ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
#########################################
if st.button("ğŸ”„ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨"):
    st.cache_data.clear()
    st.experimental_rerun()

st.write("\nëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ âœ…")
st.write("ì´ì œ ëŒ€ì‹œë³´ë“œë¥¼ í†µí•´ ì‹¤ì‹œê°„ ì½”ì¸ ìƒíƒœ í™•ì¸ ê°€ëŠ¥")
